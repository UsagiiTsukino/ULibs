<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ULibs - Quên mật khẩu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="../public/img/logo/logo.jpg">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/fonts/FontAwesome.otf"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/fonts/fontawesome-webfont.eot"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/fonts/fontawesome-webfont.svg"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/fonts/fontawesome-webfont.ttf"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/fonts/fontawesome-webfont.woff2"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css.map"
    />
    <link rel="stylesheet" href="../../css/login.css">
    <link rel="stylesheet" href="../../css/forgot-password.css">
    <link rel="stylesheet" href="../../css/toast.css">
    <script>
      if (document.location.search.match(/type=embed/gi)) {
        window.parent.postMessage("resize", "*");
      }
    </script>
  </head>

  <body>
        <div class="form-section" >
          <div class="form">
              <div class="distance"></div>
              <div class="title">
                <h1>Quên mật khẩu</h1>
              </div>
              <div class="input-info">
                  <div class="email-section">
                  <i class="fa fa-envelope" style=""></i>
                    <input
                        type="email"
                        placeholder="Nhập tài khoản email của bạn"
                        required=""
                        autocomplete="off"
                        validate=""
                        name="email"
                        id="email"
                    />
                  </div>
                  <div class="btn-submit js-findEmail">
                    <div>
                        <a class="btn-slide" href="#" >
                        <span class="circle">
                          <i class="fa fa-lock" style="margin-left: 34%; margin-top: 25%"></i>
                        </span>
                      
                        <span class="title" > Tiếp tục </span>
                        <span class="title title-hover">Gửi mã xác thực OTP</span>
                      </a>
                    </div>
                  </div>
            </div>
          </div>
          <div class="otp-section">
            <h1>Mã OTP xác minh đã được gửi tới email của bạn. </h1>
            <div class="prompt">
              Vui lòng kiểu tra hòm thư email và nhập vào dưới để hoàn thành xác nhận
            </div>
            
            <form method="get" class="digit-group" data-group-name="digits" data-autosubmit="false" autocomplete="off">
              <input type="text" id="digit-1" name="digit-1" data-next="digit-2" />
              <input type="text" id="digit-2" name="digit-2" data-next="digit-3" data-previous="digit-1" />
              <input type="text" id="digit-3" name="digit-3" data-next="digit-4" data-previous="digit-2" />
              <span class="splitter">&ndash;</span>
              <input type="text" id="digit-4" name="digit-4" data-next="digit-5" data-previous="digit-3" />
              <input type="text" id="digit-5" name="digit-5" data-next="digit-6" data-previous="digit-4" />
              <input type="text" id="digit-6" name="digit-6" data-previous="digit-5" />
            </form>
            <div class="button js-submit-otp" id="button-7">
              <div id="dub-arrow"><img src="https://github.com/atloomer/atloomer.github.io/blob/master/img/iconmonstr-arrow-48-240.png?raw=true" alt="" /></div>
              <a href="#">Xác nhận</a>
            </div> 
          </div>
        <div class="form reset-password">
          <p>Thay đổi mật khẩu mới</p>
          <div class="input-info form-reset">
            <input type="password" name="password" id="password" placeholder="Mật khẩu" />
            <input type="password" name="re-password" id="re-password" placeholder="Nhập lại mật khẩu" />
            <div class="btn-submit js-reset-password">
              <div>
                  <a class="btn-slide" href="#" >
                  <span class="circle">
                    <i class="fa fa-lock" style="margin-left: 34%; margin-top: 25%"></i>
                  </span>
                
                  <span class="title" > Tiếp tục </span>
                  <span class="title title-hover">Xác nhận thay đổi<i></i></span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
        <div id="toast"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script>
    function toast({ title = "", message = "", type = "info", duration = 3000 }) {
        const main = document.getElementById("toast");
        if (main) {
            const toast = document.createElement("div");

            // Auto remove toast
            const autoRemoveId = setTimeout(function () {
                main.removeChild(toast);
            }, duration + 1000);

            // Remove toast when clicked
            toast.onclick = function (e) {
                if (e.target.closest(".toast__close")) {
                    main.removeChild(toast);
                    clearTimeout(autoRemoveId);
                }
            };

            const icons = {
                success: "fas fa-check-circle",
                info: "fas fa-info-circle",
                warning: "fas fa-exclamation-circle",
                error: "fas fa-exclamation-circle"
            };
            const icon = icons[type];
            const delay = (duration / 1000).toFixed(2);

            toast.classList.add("toast", `toast--${type}`,"animate__animated","animate__fadeInRight");
            // toast.style.animation = `slideInLeft ease .3s, fadeOut linear 1s ${delay}s forwards`; 
            toast.innerHTML = `
                                    <div class="toast__icon">
                                        <i class="${icon}"></i>
                                    </div>
                                    <div class="toast__body">
                                        <h3 class="toast__title">${title}</h3>
                                        <p class="toast__msg">${message}</p>
                                    </div>
                                    <div class="toast__close">
                                        <i class="fas fa-times"></i>
                                    </div>
                                `;
            main.appendChild(toast);

            setTimeout(function () {    
                toast.classList.remove("animate__fadeInRight");
                toast.classList.add("animate__bounceOutRight");
                //main.removeChild(toast); 
            }, 5000);
        }
      }
        function findEmail() {
          $.ajax({  
            url: '/forgetPassword',
            type: 'POST',
            data: {
              email : $('#email').val(),
              code : 'email',
            }
          })
            .then(data => {
              if(data.message == true){
                $('.form').css('display', 'none')
                $('.otp-section').css('display', 'flex');
              }
              else {
                toast({
                  title: "Không tìm thấy email của bạn",
                  message: "Email của bạn chưa được sử dụng để đăng kí bất cứ tài khoản nào",
                  type: "error",
                  duration: 50000
                })
              }
          })
            .catch(err => {
              console.log(err);
            });
      }
      $('.js-findEmail').click(() => {
          findEmail();
        })
        </script>
        <script>
          function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            let expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
          }
          var otpCode = '';
          $('.digit-group').find('input').each(function() {
            $(this).attr('maxlength', 1);
            $(this).on('keyup', function(e) {
              var parent = $($(this).parent());
              
              if(e.keyCode === 8 || e.keyCode === 37) {
                var prev = parent.find('input#' + $(this).data('previous'));
                
                if(prev.length) {
                  $(prev).select();
                }
              } else if((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 65 && e.keyCode <= 90) || (e.keyCode >= 96 && e.keyCode <= 105) || e.keyCode === 39) {
                var next = parent.find('input#' + $(this).data('next'));
                
                if(next.length) {
                  $(next).select();
                } else {
                  if(parent.data('autosubmit')) {
                    parent.submit();
                  }
                }
              }
            });
          });
          const otp = () => {
            otpCode = ''
            for (var i = 1; i <= 6; i++) {
              otpCode += $(`input#digit-${i}`).val()
            }
            return otpCode;
          }
          function sendOTP () {
            $.ajax({  
            url: '/forgetPassword',
            type: 'POST',
            data: {
              otp : otp(),
              code : 'otp',
            }
          })
            .then(data => {
              if(data.message == true){
                toast({
                  title: "Nhập đúng OTP",
                  message: "Chuẩn rồi đó",
                  type: "success",
                  duration: 50000
                })
                $('.otp-section').css('display', 'none')
                $('.reset-password').css('display', 'block')
              }
              else {
                toast({
                  title: "Nhập sai rùi hjx :<",
                  message: "Mã OTP sai vui lòng thử lại",
                  type: "error",
                  duration: 50000
                })
              }
          })
            .catch(err => {
              console.log(err);
            });
          }
          $('.js-submit-otp').click(() => {
            sendOTP();
          })
          const resetPassword = () => {
              if ($('input#password').val() === $('input#re-password').val()) {
                $.ajax({  
                  url: '/forgetPassword',
                  type: 'POST',
                  data: {
                    password : $('input#password').val(),
                    email : $('input#email').val(),
                    code : 'new-password',
                  }
                })
                  .then(data => {
                    if(data.message){
                      setCookie('token', data.token, 1);
                      window.location.pathname = '/';
                    }
                    else {
                      toast({
                        title: "Nhập sai rùi hjx :<",
                        message: "Có lỗi xảy ra ",
                        type: "error",
                        duration: 50000
                      })
                    }
                })
                  .catch(err => {
                    console.log(err);
                  });
              }
          }
          $('.js-reset-password').click(() => resetPassword())
        </script>
  </body>
</html>
